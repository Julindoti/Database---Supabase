<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <title>ColorArt</title>
    <link rel="stylesheet" href="/global.css">
   
</head>
<body class="">
    
    <button  class="menu-botao" onclick="Change()" ></button >
    <div class="container-perfil" id="perfil">
    
    <div class="perfil"></div>

    <hr style="width: 100%; position: absolute;  border:1.5px solid white  ; top:150px;">

   <ul style="position: absolute; font-size:20px; bottom:40%;">menu
        <li>teste</li>
        <li>teste</li>
        <li><input type="file" id="arquivoinput">
        </li>
       
        <li><a style="text-decoration:none; color:white !important;" href="/loginSupabase-main/loginSupabase-main/cadastro.html">Sair</a>

    </div>

    <h2 id="mensagem" class="boas-vindas">Carregando...</h2>
    </div>
   
   <canvas id="canvas" height="500" width="700" class="tela"></canvas>
    
   <ul id="menu-btns">

        <li id="resize-brush" class="pincel" > 
            <img src="Icons/brush_24dp_000000_FILL0_wght400_GRAD0_opsz24.svg" class="icons" style="width:30px !important;">
            <span>Pincel</span>
            <input type="range" min="0.5" max="20" value="5" class="brush-slide" id="size"> 
        </li>

        <li id="Borracha">
            <img  src="Icons/ink_eraser_24dp_000000_FILL0_wght400_GRAD0_opsz24.svg" class="icons">
            <span>Borracha</span>
        </li>

        <div class="cores"> 
          <label class="titulo"><img src="Icons/palette_24dp_000000_FILL0_wght400_GRAD0_opsz24.svg"> Paleta de Cores </label>
        <ul class="opcoes">
        <li class="opcao" data-cor="white"></li> 
        <li class="opcao" data-cor="black"></li>
        <li class="opcao" data-cor="red"></li>
        <li class="opcao" data-cor="blue"></li>
        <li class="opcao" data-cor="green"></li>
        <li class="opcao" data-cor="yellow"></li>
        </ul>
        </div>
        <div class="botoes">
        <button class="limpar-quadro" onclick="Apagar()">Limpar</button>
        <button class="salvar-img ">Salvar</button>
        </div>       

    </ul>

    <h1 class="galeria-titulo"> Galeria de  Imagens </h1>
    <form>
        <input type="file" id="teste">
        
    </form>
    <div class="galeria-container" id="galeria">
    
</div>
<script >
        

        const canvas=document.getElementById('canvas');
        const cursor= canvas.getContext('2d');
        const sizeBrush = document.getElementById('size');
        const containerPerfil= document.getElementById("perfil");
        const borracha = document.getElementById("Borracha");
        const pincel =document.querySelectorAll(".pincel");
        const save = document.querySelector(".salvar-img");
        const galeria= document.getElementById("galeria");

        let isDrawing= false,
        brushsize= 5,
        material= "brush",
        brushColor= "black";
        
        const canvasBackground= ()=>{

            cursor.fillStyle="white"
            cursor.fillRect(0, 0, canvas.width, canvas.height);
            cursor.fillStyle= selectedColor;

        }
        const selectedColor = ()=>{
            document.addEventListener("click",  (event)=>{
            if(event.target.classList.contains("opcao")){
                material="brush"
                newBrush= event.target.dataset.cor;
                cursor.strokeStyle= newBrush;
            }
          })
        }
        

        window.addEventListener("load", ()=>{
            
            canvas.width= canvas.offsetWidth;
            canvas.height= canvas.offsetHeight;
            canvasBackground();
        })
        canvas.addEventListener("mousedown", startDrawing);
        canvas.addEventListener("mousemove", Drawing);
        canvas.addEventListener("mouseup", stopDrawing);

        
        function startDrawing(event){
        
            isDrawing=true;
            cursor.beginPath();
            cursor.moveTo(event.offsetX, event.offsetY) 
            cursor.lineWidth= brushsize;
       
         
        }

        function Drawing(event){
            if(!isDrawing) return;
            if(material==="brush" || material === "eraser"){
            cursor.strokeStyle= material === "eraser" ? "white" : selectedColor();
            cursor.lineTo(event.offsetX, event.offsetY);
            cursor.stroke();
            console.log(material)

            }
        }
        function stopDrawing(){

            isDrawing=false;
        }
     
     
        sizeBrush.addEventListener("change", () => {
            
            material="brush";
            brushsize= sizeBrush.value;
            
        
        });

     function Change(){

        if (containerPerfil.style.left === "120%"){
        containerPerfil.style.left="0px";
        }
        
        else{

            containerPerfil.style.left="120%";
        }
     }
     borracha.addEventListener("click", (event)=>{

        material= "eraser";
        console.log('eraser')
     })

     function erase(event){
        
        cursor.beginPath();
        cursor.clearRect(event.offsetX, event.offsetY,  brushsize, brushsize);
         
     }
   
     function Apagar(){
        
      
        cursor.clearRect(0,0, canvas.width, canvas.height);
        canvasBackground();


        }
        
       
        const usuarioEmail = localStorage.getItem("usuarioEmail");
        const usuario = localStorage.getItem("nomeUsuario");

        if (usuarioEmail) {
            document.getElementById("mensagem").innerText = `Bem-vindo, ${usuario}! Aqui vocÃª esta seguroðŸ”¥ `;
        } else {
            document.getElementById("mensagem").innerText = "UsuÃ¡rio nÃ£o autenticado!";
        }

        function logout() {
            localStorage.removeItem("nomeUsuario")
            localStorage.removeItem("usuarioEmail");
           
            window.location.href = "cadastro.html";
        }


        const supabase = window.supabase.createClient(
            "https://nzvzwpffucfzyliezfef.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56dnp3cGZmdWNmenlsaWV6ZmVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI5OTA0MjksImV4cCI6MjA1ODU2NjQyOX0.O5SJfOmzOKxzITvMcn_3lrGvuD1m_VIHnmQZe5d2vmo");
    
       
        const dataURL=canvas.toDataURL();
        
     let images="";
     
        
     //https://nzvzwpffucfzyliezfef.supabase.co/storage/v1/object/public/images/f102c70f-0471-48a2-bbe0-7f940d222922/%201744123239993.png

     const CDNURL= 'https://nzvzwpffucfzyliezfef.supabase.co/storage/v1/object/public/images/';
     
    
        async function uploadDesenho(event) {
            const {data :{user}, error: userError}= await supabase.auth.getUser();

            if(!user || userError){

                alert('deu errado')
                return;
    
            }
            
        async function getImages(){

            const{data, error}= await  supabase
            .storage
            .from("images")
            .list(`${user.id}/`, {
             limit:10,
             offset:0, 
             sortBy:{column:"name", order:"asc"}  

            });
            if(data !== null){

                images=data;


            }else{

                console.log(error)
            }
     };
          
            
        canvas.toBlob( async function(blob){
                if(!blob){
                    console.error('deu ruim');
                    return;
        }

        const desenhos = `${Date.now()}.png`;
        if (!desenhos){

            alert ("NADA SELECIONADO")
            return;

        }
    
        
      

        const {data, error}= await supabase
        .storage
        .from("images")
        .upload(`${user.id}/ ${desenhos}` , blob,
        {contentType:"file.type",
        upsert:false,
        cacheControl:"3600",
    
        });

        console.log(user)
        
        if(data){

            getImages();
            console.log(images)
            console.log('teste')

        }
        else{

          console.log("algo deu errado")

        }
    }, "images/png")

 const unico = images.map(image => {

     const imagem = document.createElement("img");
     imagem.src= CDNURL + user.id + "/"+ image.name;
     imagem.classList.add("imagem")
     galeria.appendChild(imagem);
    
 });       
         
}
   
    save.addEventListener("click", uploadDesenho)
    
 

    </script>

</body>
</html>
